## 修订版《Overview vNext》

### 1. 愿景与价值主张

* **愿景**：打造一款“对话即导游”的IOS应用。至少在iphone IOS18.1要测试通过。
  用户在旅途中**拍照**或**到点**即可在一个对话界面中获得**高质量讲解**，边走边听、可聊可控、弱网依旧顺畅。
* **核心价值**：

  1. **零学习成本**（主屏即相机）
  2. **讲解即聊天**（对话式气泡展示、点气泡播放、自动滚动高亮）
  3. **可个性化调节**（通过自然语言控制讲解长度、语气、语言）
  4. **离线与复用优先**（命中复用 + 缓存机制）
  5. **低功耗、低打扰**（轻定位策略 + 到点提醒）

---

### 2. 用户与场景

* **目标用户**：自由行游客、亲子家庭、文化探索者、差旅人群。
* **典型场景**：

  * 到达爱丁堡城堡，系统自动在聊天界面推送“🏰 我来讲讲这座城堡的故事吧…”并开始播放；
  * 拍下雕塑，几秒内返回多段气泡：“这是苏格兰诗人罗伯特·彭斯”“他以浪漫主义诗歌著称”，用户点气泡播放；
  * 输入“儿童版讲解”或“简短一点”，系统重新生成内容。

---

### 3. 产品边界与范围（MVP）

* **功能范围**：

  * iOS（SwiftUI）主相机 + 抽屉（地图 / 设置）；
  * 登录：Apple + WeChat（可游客）；
  * 定位：精确/模糊切换；到点自动触发；
  * 讲解两模式：

    1. **位置触发**（附近点命中即播放）
    2. **拍照触发**（图片 + GPS → 向量检索 → 命中复用或 GPT+TTS 生成）；
  * **Chat Overlay 为主交互界面**：

    * 系统讲解以聊天气泡形式流式呈现；
    * 每段文本对应音频片段，点击播放；
    * 自动播放时，当前段落高亮；
    * 用户可直接在输入框中发出再生成指令（如“更活泼”“英文版”）。
  * **历史整合**：每次讲解即为一个线程；历史记录即对话历史，可搜索与重播；
  * 播放控件嵌入 Chat 窗底部（播放、暂停、跳句、倍速、回听15s）；
  * **到点自动播**：默认推送通知；用户开启“自动播放”并连接耳机时自动播；
  * 缓存：离线可用、500MB LRU；
  * 隐私：默认允许用于改进服务，可关闭；
  * 埋点：全链路事件 + 崩溃日志。
* **不在范围**：社区评论、社交分享、PC/Android 客户端。

---

### 4. 关键指标（KPI/NFR）

* **性能目标**：

  * 命中首帧 ≤ **3s**；新生成 ≤ **8s**；
  * 拍照至音频返回 ≤ **10s**；
  * 到点触发播放 P95 ≤ **2.5s**；
  * 播放恢复 < **300ms**；日耗电 ≤ **5%**。
* **稳定性**：崩溃率 < **0.3%**；自动播放成功率 > **98%**。
* **体验指标**：命中率、离线命中率、反馈“有用率”、听播时长、次日留存。

---

### 5. 体验原则

* **相机即主页** — 拍照即导览。
* **讲解即聊天** — 所有内容通过对话展示与播放。
* **先声后文** — 流式播放优先，文本同步流入。
* **自然可控** — 用户可用自然语言改变内容。
* **离线优先、低功耗、不打扰**。

---

### 6. 信息架构与关键流程（摘要）

* **主屏（相机）**：全屏预览 + 快门；顶部定位条（精准/模糊）；右缘抽屉（地图/设置）。
* **Chat Overlay（核心）**：

  * 展示讲解文本、播放控件、输入栏；
  * 历史即对话线程；
  * 自动播放时动态滚动与高亮。
* **地图**：展示附近点位；点击点进入对应聊天线程。
* **关键状态机**：`idle → locating → capture → upload → matching → generating → tts → ready`。
* **后台与通知**：`BackgroundTasks`；完成后本地通知“讲解已准备就绪”。

---

### 7. 技术架构（高层）

* **客户端**：SwiftUI + Combine/async-await + Clean MVVM；

  * 相机：AVFoundation；定位：CoreLocation（围栏/Visits）；
  * 音频：AVPlayer（流式播放）；
  * Chat Overlay：异步流式文本/音频绑定；
  * 缓存：SQLite/CoreData + 文件分目录；
  * 登录：Apple / WeChat；监控：MetricKit + Crashlytics。
* **服务端**：FastAPI / Flask；

  * 向量检索：PostgreSQL + PostGIS + PGVector；
  * 生成链路：GPT（文本）→ Google TTS（语音）；
  * 输出结构：多段文本 + 对应音频 URL；
  * 复用键：先通过向量检索拿到top-k images，然后通过`hash(image|lang|voice|style)`；
  * 幂等控制：`Idempotency-Key`。

---

### 8. 数据与隐私

* **本地**：索引数据库 + LRU 缓存；
* **云端**：MinIO / Cloud Storage；PostgreSQL（结构化数据）；
* **安全**：传输 TLS；访问控制分桶；
* **隐私**：默认留存 ≤ 365 天，可手动删除；不用于第三方训练。

---

### 9. 权限与设置

* Info.plist：相机、定位、语音、后台模式声明。
* 设置页：语言、TTS 声音、自动播放、缓存清理、隐私与数据导出。

---

### 10. 测试与发布

* 单测 + XCUITest（含 GPX 围栏模拟）；
* 弱网、耳机、锁屏、来电全覆盖测试；
* TestFlight 灰度；App Store 审核隐私合规。

---

### 11. 风险与对策

* **弱网断流** → 文本回退、缓存命中；
* **定位误触发** → 围栏去抖 + 最短播间隔；
* **生成延迟** → 分段流式返回；
* **功耗风险** → Visits 优先 + 后台节流；
* **自动播放合规** → 仅耳机连接 + 用户授权时启用。

---

### 12. 里程碑（建议）

M0 原型 → M1 核心链路 → M2 到点/离线 → M3 体验优化 → M4 Beta → M5 上架。


---

# 接下来要展开的子项目录

1. **信息架构与交互细节（IA + Flow）**
2. **客户端技术方案（SwiftUI/Clean+MVVM/依赖注入/并发/组件拆分）**
3. **定位与地图策略（功耗、围栏、去抖、吸附、地图交互）**
4. **多媒体与 TTS（音频会话、流式、逐字高亮、播放器控件）**
5. **数据与缓存策略（离线包、LRU、索引 DB、复用键）**
6. **弱网与离线降级（上传队列、指数退避、文本回退、通知）**
7. **客户端—服务端接口规范（v1 API 全量、SSE、错误码、幂等与安全）**
8. **隐私与合规（权限文案、营养标签、最小化、数据导出/删除）**
9. **埋点与可观测性（事件清单、KPI 口径、日志等级、仪表盘）**
10. **性能与能耗目标（测量方法、优化清单、阈值门禁）**
11. **测试与验收（单测/UI 测试/GPX/快照/可用性走查清单）**
12. **运维与发布（环境、配置、Feature Flag、灰度与回滚）**
13. **设计规范与 Figma 指南（Tokens、组件、暗色模式、无障碍）**
14. **风险清单与备选方案（技术/合规/体验）**
15. **术语表与数据字典**
